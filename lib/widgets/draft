import 'dart:io';
import 'dart:typed_data';
import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:flutter_spinkit/flutter_spinkit.dart';
import 'package:gal/gal.dart';
import 'package:image/image.dart' as img; // For image conversion
import 'package:path_provider/path_provider.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:flutter_gen/gen_l10n/app_localizations.dart';

class DownloadButton extends StatefulWidget {
  final String imageUrl;
  final String downloadLocation; // ✅ New: Unsplash download endpoint
  final String? imageId; // Optional ID for filename

  const DownloadButton({
    super.key,
    required this.imageUrl,
    required this.downloadLocation,
    this.imageId,
  });

  @override
  State<DownloadButton> createState() => _DownloadButtonState();
}

class _DownloadButtonState extends State<DownloadButton> {
  bool _isLoading = false;

  Future<void> _downloadAndSaveImage() async {
    if (_isLoading) return;
    setState(() => _isLoading = true);

    try {
      // ✅ Step 1: Check and request permissions
      if (Platform.isAndroid) {
        final status = await Permission.storage.request();
        if (!status.isGranted) {
          if (!mounted) return;
          throw Exception(AppLocalizations.of(context)!.storagePermissionDenied);
        }
      }

      final dio = Dio();

      // ✅ Step 2: Trigger Unsplash download tracking
      await dio.get(widget.downloadLocation);

      // ✅ Step 3: Download the actual image bytes
      final response = await dio.get(
        widget.imageUrl,
        options: Options(responseType: ResponseType.bytes),
      );

      // ✅ Step 4: Convert to JPEG if needed
      final Uint8List jpegBytes = await _convertToJpegIfNeeded(response.data);

      // ✅ Step 5: Save to temporary file
      final tempDir = await getTemporaryDirectory();
      final filePath = '${tempDir.path}/${_generateImageName()}.jpg';
      final file = File(filePath);
      await file.writeAsBytes(jpegBytes);

      // ✅ Step 6: Save to gallery
      await Gal.putImage(filePath);

      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppLocalizations.of(context)!.imageSavedToGallery),
          duration: const Duration(seconds: 2),
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${AppLocalizations.of(context)!.error}: ${e.toString()}'),
        ),
      );
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<Uint8List> _convertToJpegIfNeeded(Uint8List originalBytes) async {
    try {
      final image = img.decodeImage(originalBytes);
      if (image == null) {
        throw Exception(AppLocalizations.of(context)!.failedToDecodeImage);
      }
      return Uint8List.fromList(img.encodeJpg(image, quality: 95));
    } catch (e) {
      return originalBytes;
    }
  }

  String _generateImageName() {
    return widget.imageId ?? 'unsplash_${DateTime.now().millisecondsSinceEpoch}';
  }

  @override
  Widget build(BuildContext context) {
    return IconButton(
      icon: _isLoading
          ? const SizedBox(
              width: 20,
              height: 20,
              child: SpinKitThreeInOut(
                color: Color.fromARGB(255, 8, 127, 148),
                size: 30.0,
              ),
            )
          : const Icon(Icons.download),
      onPressed: _downloadAndSaveImage,
      tooltip: AppLocalizations.of(context)!.saveToGallery,
    );
  }
}